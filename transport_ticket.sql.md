
---


```sql
-- Transport Ticket System
-- Student: Ndayisenga Anasi
-- ID: 28423
-- Database: Oracle SQL

SET SERVEROUTPUT ON;

-- DROP TABLES
BEGIN EXECUTE IMMEDIATE 'DROP TABLE audit_log CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE payments CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE tickets CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE schedules CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE routes CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE buses CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE passengers CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- SEQUENCES
CREATE SEQUENCE ticket_seq START WITH 1001;
CREATE SEQUENCE payment_seq START WITH 5001;

-- TABLES
CREATE TABLE passengers (
    passenger_id NUMBER PRIMARY KEY,
    full_name VARCHAR2(100),
    phone VARCHAR2(20),
    email VARCHAR2(100)
);

CREATE TABLE buses (
    bus_id NUMBER PRIMARY KEY,
    plate_no VARCHAR2(20),
    capacity NUMBER,
    operator VARCHAR2(100)
);

CREATE TABLE routes (
    route_id NUMBER PRIMARY KEY,
    origin VARCHAR2(100),
    destination VARCHAR2(100),
    base_fare NUMBER
);

CREATE TABLE schedules (
    schedule_id NUMBER PRIMARY KEY,
    route_id NUMBER REFERENCES routes(route_id),
    bus_id NUMBER REFERENCES buses(bus_id),
    departure_time TIMESTAMP,
    arrival_time TIMESTAMP,
    available_seats NUMBER
);

CREATE TABLE tickets (
    ticket_id NUMBER PRIMARY KEY,
    passenger_id NUMBER REFERENCES passengers(passenger_id),
    schedule_id NUMBER REFERENCES schedules(schedule_id),
    seat_no VARCHAR2(10),
    fare NUMBER,
    status VARCHAR2(20),
    booked_at TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE payments (
    payment_id NUMBER PRIMARY KEY,
    ticket_id NUMBER REFERENCES tickets(ticket_id),
    amount NUMBER,
    paid_at TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE audit_log (
    audit_id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    event_type VARCHAR2(50),
    event_details VARCHAR2(200),
    event_time TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- SAMPLE DATA
INSERT INTO passengers VALUES (1, 'Alice Uwimana', '0788000001', 'alice@gmail.com');
INSERT INTO buses VALUES (1, 'RAB123A', 40, 'Kigali Express');
INSERT INTO routes VALUES (1, 'Kigali', 'Huye', 3000);
INSERT INTO schedules VALUES (1, 1, 1, SYSTIMESTAMP, SYSTIMESTAMP+INTERVAL '3' HOUR, 40);

COMMIT;

-- FUNCTION
CREATE OR REPLACE FUNCTION calc_fare(p_route_id NUMBER)
RETURN NUMBER IS v_fare NUMBER;
BEGIN
    SELECT base_fare INTO v_fare FROM routes WHERE route_id=p_route_id;
    RETURN v_fare;
END;
/

-- PACKAGE
CREATE OR REPLACE PACKAGE ticket_pkg AS
    PROCEDURE book_ticket(p_passenger NUMBER, p_schedule NUMBER, p_seat VARCHAR2, p_amount NUMBER);
END;
/

CREATE OR REPLACE PACKAGE BODY ticket_pkg AS
PROCEDURE book_ticket(p_passenger NUMBER, p_schedule NUMBER, p_seat VARCHAR2, p_amount NUMBER) IS
v_id NUMBER;
BEGIN
    v_id := ticket_seq.NEXTVAL;
    INSERT INTO tickets VALUES (v_id, p_passenger, p_schedule, p_seat, p_amount, 'BOOKED', SYSTIMESTAMP);
    UPDATE schedules SET available_seats = available_seats - 1 WHERE schedule_id = p_schedule;
    INSERT INTO payments VALUES (payment_seq.NEXTVAL, v_id, p_amount, SYSTIMESTAMP);
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Ticket booked: '||v_id);
END;
END;
/

-- TRIGGER
CREATE OR REPLACE TRIGGER trg_ticket_log
BEFORE INSERT ON tickets
FOR EACH ROW
BEGIN
    INSERT INTO audit_log(event_type, event_details)
    VALUES('TICKET_BOOKED','Passenger '||:NEW.passenger_id);
END;
/
